{% extends "base.html" %}
{% block title %} üéÅ Collect Your Prize! {% endblock %}

{% block content %}
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden; /* Prevent scrolling */
    background: linear-gradient(135deg, #f093fb, #f5576c);
    color: #fff;
    font-family: 'Arial', sans-serif;
    touch-action: none; /* Prevent touch scrolling */
  }

  /* üé® Floating Home Button */
  .home-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    transition: transform 0.2s ease, background 0.2s ease;
    z-index: 1000;
  }

  .home-btn:hover {
    transform: scale(1.1);
    background: rgba(255, 255, 255, 0.3);
  }

  .home-btn img {
    width: 60%;
    height: 60%;
  }

  .celebration-container {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 500px;
    text-align: center;
    animation: fadeIn 1.5s ease-in;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translate(-50%, -40%); }
    to { opacity: 1; transform: translate(-50%, -50%); }
  }

  .winner-card {
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(15px);
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    margin: 20px 0;
  }

  .scratch-card-container {
    background-color: white;
    position: relative;
    width: 100%;
    max-width: 350px;
    aspect-ratio: 3 / 2;
    margin: 0 auto;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  }

  canvas#scratch-card {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    cursor: grab;
  }

  .gift-image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  /* Small screens */
  @media (max-width: 480px) {
    .winner-card h3 { font-size: 1.2rem; }
    .celebration-container h1 { font-size: 1.6rem; }
    .scratch-card-container { max-width: 280px; }
  }
</style>

<!-- Home Button -->
<a href="/" class="home-btn">
  <img src="{{ url_for('static', filename='images/home_icon.svg') }}" alt="Home">
</a>

<div class="celebration-container">
  <h1 class="mb-4 fw-bold">üéâ Congratulations, {{ user.name }}! üéâ</h1>
  <p class="lead mb-4">You‚Äôve successfully won a mystery gift! Your reward will be sent to <strong>{{ user.email }}</strong>.</p>

  <div class="winner-card">
    <h3 class="mb-3">Scratch to Reveal Your Prize üéÅ</h3>
    <div class="scratch-card-container">
      <img src="{{ url_for('static', filename='images/airpod_pro_3.jpeg') }}" class="gift-image" alt="AirPods Pro 3">
      <canvas id="scratch-card"></canvas>
    </div>
  </div>

  <div class="mb-5">
    *The collection details will be sent to your email address
  </div>
</div>

<canvas id="confetti-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;"></canvas>

<script>
  // Lock scrolling and disable pull-to-refresh
  document.body.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
  document.addEventListener('gesturestart', e => e.preventDefault()); // Prevent zooming on iOS

  // Scratch Card Logic
  const canvas = document.getElementById('scratch-card');
  const ctx = canvas.getContext('2d');
  const container = document.querySelector('.scratch-card-container');

  function resizeCanvas() {
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    ctx.fillStyle = "#aaa";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  let isDrawing = false;

  function scratch(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX || e.touches[0].clientX) - rect.left;
    const y = (e.clientY || e.touches[0].clientY) - rect.top;

    ctx.globalCompositeOperation = 'destination-out';
    ctx.beginPath();
    ctx.arc(x, y, 20, 0, 2 * Math.PI);
    ctx.fill();
  }

  canvas.addEventListener('mousedown', () => isDrawing = true);
  canvas.addEventListener('mouseup', () => isDrawing = false);
  canvas.addEventListener('mousemove', scratch);

  canvas.addEventListener('touchstart', () => isDrawing = true);
  canvas.addEventListener('touchend', () => isDrawing = false);
  canvas.addEventListener('touchmove', scratch);

  // üéä Confetti Animation with fade-out
  const confettiCanvas = document.getElementById('confetti-canvas');
  const confettiCtx = confettiCanvas.getContext('2d');
  confettiCanvas.width = window.innerWidth;
  confettiCanvas.height = window.innerHeight;

  const confetti = Array.from({length: 150}, () => ({
    x: Math.random() * confettiCanvas.width,
    y: Math.random() * confettiCanvas.height,
    r: Math.random() * 6 + 2,
    d: Math.random() * 0.5 + 0.5,
    color: `hsl(${Math.random()*360}, 70%, 60%)`,
    opacity: 1
  }));

  let fadeOut = false;
  let confettiAnimation;

  function drawConfetti() {
    confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
    confetti.forEach(c => {
      confettiCtx.beginPath();
      confettiCtx.arc(c.x, c.y, c.r, 0, 2 * Math.PI);
      confettiCtx.fillStyle = c.color.replace('hsl', 'hsla').replace(')', `,${c.opacity})`);
      confettiCtx.fill();
      c.y += c.d;
      if (c.y > confettiCanvas.height) { c.y = 0; c.x = Math.random() * confettiCanvas.width; }
      if (fadeOut && c.opacity > 0) c.opacity -= 0.02;
    });

    if (fadeOut && confetti.every(c => c.opacity <= 0)) {
      cancelAnimationFrame(confettiAnimation);
      confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
      return;
    }
    confettiAnimation = requestAnimationFrame(drawConfetti);
  }

  drawConfetti();
  setTimeout(() => fadeOut = true, 3000);
</script>
{% endblock %}
